{% extends 'base.html' %}
{% load static %}

{% block header_tabs %}
<div class="tabs">
    <a class="tab active" href="?tab=sales">Sales</a>
</div>
{% endblock %}

{% block content %}
<div class="page-wrap">
    <!-- Sales Search Tab -->
    {% if active_tab == 'sales' %}
        <div id="sales-search">
            <h1 class="page-title">Sales Search</h1>

            <form method="GET" action="{% url 'main_page' %}" class="pf-card">
                <input type="hidden" name="tab" value="sales">
                
                <div class="pf-form-cols">
                    <div class="pf-col">
                        <div class="pf-field">
                            <label class="pf-label" for="sales_invoice_number">Invoice No.</label>
                            <input type="text" class="pf-input" id="sales_invoice_number" name="sales_invoice_number" 
                                   value="{{ request.GET.sales_invoice_number }}" placeholder="Search by invoice number">
                        </div>
                        
                        <div class="pf-field">
                            <label class="pf-label" for="sales_customer">Customer</label>
                            <select class="pf-select" id="sales_customer" name="sales_customer">
                                <option value="">All Customers</option>
                                {% for customer in customers %}
                                    <option value="{{ customer.customer_id }}" {% if request.GET.sales_customer == customer.customer_id %}selected{% endif %}>
                                        {{ customer.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="pf-field">
                            <label class="pf-label" for="sales_payment_status">Payment Status</label>
                            <select class="pf-select" id="sales_payment_status" name="sales_payment_status">
                                <option value="">All Status</option>
                                <option value="Paid" {% if request.GET.sales_payment_status == 'Paid' %}selected{% endif %}>Paid</option>
                                <option value="Unpaid" {% if request.GET.sales_payment_status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                                <option value="Partial" {% if request.GET.sales_payment_status == 'Partial' %}selected{% endif %}>Partial</option>
                            </select>
                        </div>
                    </div>

                    <div class="pf-col">
                        <div class="pf-field">
                            <label class="pf-label" for="sales_start_date">From Date</label>
                            <input type="date" class="pf-input" id="sales_start_date" name="sales_start_date" 
                                   value="{{ request.GET.sales_start_date }}">
                        </div>
                        
                        <div class="pf-field">
                            <label class="pf-label" for="sales_end_date">To Date</label>
                            <input type="date" class="pf-input" id="sales_end_date" name="sales_end_date" 
                                   value="{{ request.GET.sales_end_date }}">
                        </div>
                        
                        <div class="pf-field">
                            <label class="pf-label" for="sales_payment_type">Payment Type</label>
                            <select class="pf-select" id="sales_payment_type" name="sales_payment_type">
                                <option value="">All Types</option>
                                <option value="Cash" {% if request.GET.sales_payment_type == 'Cash' %}selected{% endif %}>Cash</option>
                                <option value="Cheque" {% if request.GET.sales_payment_type == 'Cheque' %}selected{% endif %}>Cheque</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="pf-actions">
                    <a href="{% url 'main_page' %}?tab=sales" class="pf-btn pf-btn-clear">Clear</a>
                    <button type="submit" class="pf-btn pf-btn-save">Search</button>
                </div>
            </form>

            <h2 class="inv-section-title">Sales Invoices</h2>
            
            <div class="pf-card">
                <div class="pf-table-wrap">
                    <table class="pf-table" id="invoices-table">
                        <thead>
                            <tr>
                                <th>Invoice No.</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th class="t-right">Total</th>
                                <th>Payment Type</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in sales_invoices %}
                            <tr class="clickable-row" data-invoice-id="{{ invoice.invoice_no }}" style="cursor: pointer;" title="Double-click to edit">
                                <td class="col-id">{{ invoice.invoice_no }}</td>
                                <td>{{ invoice.date|date:"m/d/y" }}</td>
                                <td class="col-desc">{{ invoice.customer.name|default:"-" }}</td>
                                <td class="t-right">₱{{ invoice.grand_total|floatformat:2 }}</td>
                                <td>
                                    {# You don't have payment_type in your model yet, so show a default #}
                                    <span class="badge status-default">Cash</span>
                                </td>
                                <td>
                                    {% if invoice.payment_status == "Paid" %}
                                        <span class="status-badge status-active">Paid</span>
                                    {% elif invoice.payment_status == "Partial" %}
                                        <span class="status-badge status-inactive">Partial</span>
                                    {% else %}
                                        <span class="status-badge status-default">Unpaid</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="t-center" style="padding: 2rem; color: #9ca3af;">No sales invoices found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 24px;">
                <div class="stat-card stat-primary">
                    <div class="stat-title">Total Invoices</div>
                    <div class="stat-value">{{ sales_invoices|length }}</div>
                </div>
                <div class="stat-card stat-success">
                    <div class="stat-title">Total Sales</div>
                    <div class="stat-value">₱{{ total_sales|floatformat:2 }}</div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-title">Total Received</div>
                    <div class="stat-value">₱{{ total_sales_received|floatformat:2 }}</div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all rows with class 'clickable-row'
    const rows = document.querySelectorAll('.clickable-row');
    
    // Add double-click event listener to each row
    rows.forEach(row => {
        row.addEventListener('dblclick', function() {
            const invoiceId = this.dataset.invoiceId;
            if (invoiceId) {
                window.location.href = `/invoice/sales/${invoiceId}/update/`;
            }
        });
    });
});
</script>

<style>
/* Additional styles for stats cards to match your theme */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: #ffffff;
    border-radius: 14px;
    border: 1px solid #e5e9f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 24px;
}

.stat-primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    border: none;
}

.stat-success {
    background: linear-gradient(135deg, #16a34a, #15803d);
    color: white;
    border: none;
}

.stat-warning {
    background: linear-gradient(135deg, #d97706, #b45309);
    color: white;
    border: none;
}

.stat-title {
    font-size: 14px;
    font-weight: 500;
    opacity: 0.9;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
}

.text-danger { color: #ef4444; }
.text-success { color: #16a34a; }

/* Badge styles to match your status badges */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}

.status-active { background: #dcfce7; color: #16a34a; }
.status-inactive { background: #fee2e2; color: #ef4444; }
.status-default { background: #f3f4f6; color: #6b7280; }
</style>
{% endblock %}