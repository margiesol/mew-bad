{% extends 'base.html' %}
{% load static %}

{% block content %}
<nav class="navbar navbar-dark mb-3" style="background-color: #590404;">
    <div class="d-flex align-items-center px-3" style="gap: 20px;">
        <span class="navbar-brand">AstovC</span>
        <a class="navbar-brand" href="{% url 'main_page' %}"><small>Invoice List</small></a>
        <a class="navbar-brand" href="{% url 'create_invoice' %}"><small>Create Invoice</small></a>
        <a class="navbar-brand" href="{% url 'profiles' %}"><small>Profiles</small></a>
    </div>
    <a class="navbar-brand" href="?logout=true"><small>Logout</small></a>     
</nav>

<div class="container" style="max-width: 1400px;">
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'product' %}active{% endif %}" href="?tab=product">
                Products
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'customer' %}active{% endif %}" href="?tab=customer">
                Customers
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'agent' %}active{% endif %}" href="?tab=agent">
                Agents
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'bank' %}active{% endif %}" href="?tab=bank">
                Banks
            </a>
        </li>
    </ul>

    <!-- PRODUCTS TAB CONTENT -->
    {% if active_tab == 'product' %}

    <!-- Product Search/Create/Edit Form - Single Card -->
    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <form id="productForm" method="POST" action="{% url 'product_create' %}">
            {% csrf_token %}
            <input type="hidden" name="tab" value="product">
            <input type="hidden" id="is_edit_product" name="is_edit" value="false">
            <input type="hidden" id="original_product_code" name="original_product_code" value="">
            <input type="hidden" id="original_description" name="original_description" value="">
            
            <!-- Row 1: Product ID, Product Code and Description -->
            <div class="row g-2 mb-3">
                <!-- Product ID (auto-generated, read-only) -->
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <label for="product_id" class="form-label profile-fixed-label">ID</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="product_id" name="product_id"
                            value="{{ next_product_id }}" readonly>
                    </div>
                </div>
                
                <!-- Product Code (NOT prefilled) -->
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <label for="product_code" class="form-label profile-fixed-label">Code</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="product_code" name="product_code"
                            value="" placeholder="Enter alphanumeric code" maxlength="10">
                    </div>
                </div>
                
                <!-- Description -->
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <label for="description" class="form-label profile-fixed-label">Description</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="description" name="description"
                            value="" placeholder="Enter product description">
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Price, Quantity, Status -->
            <div class="row g-2 mb-3">
                <!-- Price -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="price" class="form-label profile-fixed-label">Price</label>
                        <input type="text" class="form-control form-control-sm text-end profile-fixed-input" id="price" name="price" 
                            value="" placeholder="0.00">
                    </div>
                </div>
                
                <!-- Quantity -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="quantity" class="form-label profile-fixed-label">Quantity</label>
                        <input type="number" class="form-control form-control-sm text-end profile-fixed-input" id="quantity" name="quantity"
                            value="0" min="0" max="100000" placeholder="0">
                    </div>
                </div>
                
                <!-- Status (replaces Unit) -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="status" class="form-label profile-fixed-label">Status</label>
                        <select class="form-select form-select-sm profile-fixed-input" id="status" name="status">
                            <option value="Active" selected>Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="row g-2">
                <div class="col-md-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" id="clearBtnProduct" class="btn btn-sm profile-clear-btn">Clear</button>
                        <button type="submit" id="saveBtnProduct" class="btn btn-sm profile-save-btn">Save</button>
                        <button type="button" id="deleteBtnProduct" class="btn btn-sm profile-delete-btn" style="display: none;">Delete</button>
                        <button type="submit" formaction="{% url 'profiles' %}?tab=product" class="btn btn-sm profile-search-btn">Search</button>
                        <button type="button" id="reportBtnProduct" class="btn btn-sm profile-report-btn">Report</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Products Table -->
    <div class="mx-auto" style="width: 80%">
        <h6 class="mb-3 text-start">Product List</h6>
    </div>

    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
            <table class="table mb-0" style="min-width: 800px;">
                <thead class="table-light" style="position: sticky; top: 0; background: white; z-index: 1;">
                    <tr>
                        <th width="80" class="text-center">ID</th>
                        <th width="100" class="text-center">Code</th>
                        <th class="text-center">Description</th>
                        <th width="150" class="text-center">Price</th>
                        <th width="120" class="text-center">Quantity</th>
                        <th width="100" class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    {% for product in products %}
                    <tr class="product-row" data-id="{{ product.product_id }}" 
                        data-code="{{ product.product_code }}"
                        data-description="{{ product.description }}"
                        data-price="{{ product.price|default:0 }}"
                        data-quantity="{{ product.quantity|default:0 }}"
                        data-status="{{ product.status }}">
                        <td class="text-center"><strong>{{ product.product_id }}</strong></td>
                        <td class="text-center">{{ product.product_code }}</td>
                        <td>{{ product.description }}</td>
                        <td class="text-end">{{ product.price|floatformat:2 }}</td>
                        <td class="text-center">{{ product.quantity }}</td>
                        <td class="text-center">{{ product.status }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            {% if request.GET %}
                                No products found matching your search.
                            {% else %}
                                No products found. Create your first product above.
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Summary -->
    <div class="mx-auto text-end" style="width: 80%">
        <strong>Total Products: {{ products|length }}</strong>
        {% if request.GET %}
            <span class="text-muted"> - Filtered results</span>
        {% endif %}
    </div>
    {% endif %}

    <!-- CUSTOMERS TAB CONTENT (EXACTLY AS YOUR WORKING CODE WITH AREA FROM VIEW) -->
    {% if active_tab == 'customer' %}

    <!-- Customer Search/Create/Edit Form - Single Card -->
    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <form id="customerForm" method="POST" action="{% url 'customer_create' %}">
            {% csrf_token %}
            <input type="hidden" name="tab" value="customer">
            <input type="hidden" id="customer_id" name="customer_id" value="">
            <input type="hidden" id="is_edit_customer" name="is_edit" value="false">
            <input type="hidden" id="original_customer_code" name="original_code" value="">
            <input type="hidden" id="original_company_name" name="original_name" value="">
            
            <!-- Row 1: Customer Code and Name -->
            <div class="row g-2 mb-3">
                <!-- Customer Code -->
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <label for="customer_id" class="form-label profile-fixed-label">ID</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="customer_id" name="customer_id"
                            value="{{ request.GET.customer_id|default:next_customer_id }}" readonly>
                    </div>
                </div>
                
                <!-- Company Name -->
                <div class="col-md-9">
                    <div class="d-flex align-items-center">
                        <label for="company_name" class="form-label profile-fixed-label">Name</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="company_name" name="company_name"
                            value="{{ request.GET.company_name }}" placeholder="Enter company name">
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Contact Person, Phone, Area -->
            <div class="row g-2 mb-3">
                <!-- Contact Person -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="contact_person" class="form-label profile-fixed-label">Contact Person</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="contact_person" name="contact_person"
                            value="{{ request.GET.contact_person }}" placeholder="Enter contact person">
                    </div>
                </div>
                
                <!-- Phone -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="phone" class="form-label profile-fixed-label">Phone #</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="phone" name="phone"
                            value="{{ request.GET.phone }}" placeholder="09XXXXXXXXXX">
                    </div>
                </div>
                
                <!-- Area (using area_choices from view) -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="area" class="form-label profile-fixed-label">Area</label>
                        <select class="form-select form-select-sm profile-fixed-input" id="area" name="area">
                            <option value="">Select Area</option>
                            {% for area_value, area_label in area_choices %}
                            <option value="{{ area_value }}">{{ area_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Address -->
            <div class="row g-2 mb-4">
                <div class="col-md-12">
                    <div class="d-flex align-items-center">
                        <label for="customer_address" class="form-label profile-fixed-label">Address</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="customer_address" name="customer_address"
                            value="{{ request.GET.customer_address }}" placeholder="123 Building Name, Street Name, Barangay, City, Province, ZIP Code">
                    </div>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="row g-2">
                <div class="col-md-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" id="clearBtnCustomer" class="btn btn-sm profile-clear-btn">Clear</button>
                        <button type="submit" id="saveBtnCustomer" class="btn btn-sm profile-save-btn">Save</button>
                        <button type="button" id="deleteBtnCustomer" class="btn btn-sm profile-delete-btn" style="display: none;">Delete</button>
                        <button type="submit" formaction="{% url 'profiles' %}?tab=customer" class="btn btn-sm profile-search-btn">Search</button>
                        <button type="button" id="reportBtnCustomer" class="btn btn-sm profile-report-btn">Report</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Customers Table -->
    <div class="mx-auto" style="width: 80%">
        <h6 class="mb-3 text-start">Customer List</h6>
    </div>
    
    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
            <table class="table mb-0" style="min-width: 800px;">
                <thead class="table-light" style="position: sticky; top: 0; background: white; z-index: 1;">
                    <tr>
                        <th width="100" class="text-center">Code</th>
                        <th class="text-center">Name</th>
                        <th class="text-center">Contact Person</th>
                        <th width="150" class="text-center">Phone Number</th>
                        <th width="120" class="text-center">Area</th>
                        <th class="text-center">Address</th>
                    </tr>
                </thead>
                <tbody id="customerTableBody">
                    {% for customer in customers %}
                    <tr class="customer-row" data-id="{{ customer.id }}" 
                        data-code="{{ customer.customer_code }}"
                        data-name="{{ customer.company_name }}"
                        data-contact="{{ customer.contact_person }}"
                        data-phone="{{ customer.phone|default:'' }}"
                        data-area="{{ customer.area|default:'' }}"
                        data-address="{{ customer.customer_address|default:'' }}">
                        <td class="text-center"><strong>{{ customer.customer_code }}</strong></td>
                        <td>{{ customer.company_name }}</td>
                        <td>{{ customer.contact_person|default:"-" }}</td>
                        <td class="text-center">{{ customer.phone|default:"-" }}</td>
                        <td class="text-center">{{ customer.area|default:"-" }}</td>
                        <td>{{ customer.customer_address|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            {% if request.GET %}
                                No customers found matching your search.
                            {% else %}
                                No customers found. Create your first customer above.
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Summary -->
    <div class="mx-auto text-end" style="width: 80%">
        <strong>Total Customers: {{ customers.count }}</strong>
        {% if request.GET %}
            <span class="text-muted"> - Filtered results</span>
        {% endif %}
    </div>
    {% endif %}

    <!-- AGENTS TAB CONTENT -->
    {% if active_tab == 'agent' %}
    <div class="mx-auto" style="width: 80%">
        <h5 class="mb-3 text-start">Agents</h5>
    </div>

    <!-- Agent Form -->
    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <form id="agentForm" method="POST" action="{% url 'agent_create' %}">
            {% csrf_token %}
            <input type="hidden" name="tab" value="agent">
            <input type="hidden" id="agent_id" name="agent_id" value="">
            <input type="hidden" id="is_edit_agent" name="is_edit" value="false">
            <input type="hidden" id="original_agent_name" name="original_name" value="">
            
            <!-- Single row with all fields: ID, Name, Phone -->
            <div class="row g-2 mb-3">
                <!-- Agent ID (auto-generated, read-only) -->
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <label for="agent_id_display" class="form-label profile-fixed-label">ID</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input bg-light" 
                            id="agent_id_display" value="{{ next_agent_id }}" readonly>
                        <input type="hidden" name="agent_id" value="{{ next_agent_id }}">
                    </div>
                </div>
                
                <!-- Agent Name -->
                <div class="col-md-5">
                    <div class="d-flex align-items-center">
                        <label for="agent_name" class="form-label profile-fixed-label">Name</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="agent_name" name="name"
                            value="" placeholder="Last Name, First Name, MI" maxlength="100">
                    </div>
                </div>
                
                <!-- Phone -->
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <label for="agent_phone" class="form-label profile-fixed-label">Phone #</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="agent_phone" name="phone_no"
                            value="" placeholder="09XX XXX XXXX" maxlength="13">
                    </div>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="row g-2">
                <div class="col-md-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" id="clearBtnAgent" class="btn btn-sm profile-clear-btn">Clear</button>
                        <button type="submit" id="saveBtnAgent" class="btn btn-sm profile-save-btn">Save</button>
                        <button type="button" id="deleteBtnAgent" class="btn btn-sm profile-delete-btn" style="display: none;">Delete</button>
                        <button type="submit" formaction="{% url 'profiles' %}?tab=agent" class="btn btn-sm profile-search-btn">Search</button>
                        <button type="button" id="reportBtnAgent" class="btn btn-sm profile-report-btn">Report</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Agents Table -->
    <div class="mx-auto" style="width: 80%">
        <h6 class="mb-3 text-start">Agent List</h6>
    </div>

    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
            <table class="table mb-0" style="min-width: 600px;">
                <thead class="table-light" style="position: sticky; top: 0; background: white; z-index: 1;">
                    <tr>
                        <th width="80" class="text-center">ID</th>
                        <th class="text-center">Name</th>
                        <th width="150" class="text-center">Phone Number</th>
                    </tr>
                </thead>
                <tbody id="agentTableBody">
                    {% for agent in agents %}
                    <tr class="agent-row" data-id="{{ agent.agent_id }}" 
                        data-name="{{ agent.name }}"
                        data-phone="{{ agent.phone_no|default:'' }}">
                        <td class="text-center"><strong>{{ agent.agent_id }}</strong></td>
                        <td>{{ agent.name }}</td>
                        <td class="text-center">{{ agent.phone_no|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center py-4">
                            No agents found. Create your first agent above.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Summary -->
    <div class="mx-auto text-end" style="width: 80%">
        <strong>Total Agents: {{ agents|length }}</strong>
    </div>
    {% endif %}

    <!-- BANKS TAB CONTENT -->
    {% if active_tab == 'bank' %}
    <div class="mx-auto" style="width: 80%">
        <h5 class="mb-3 text-start">Banks</h5>
    </div>

    <!-- Bank Form -->
    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <form id="bankForm" method="POST" action="{% url 'bank_create' %}">
            {% csrf_token %}
            <input type="hidden" name="tab" value="bank">
            <input type="hidden" id="bank_id" name="bank_id" value="">
            <input type="hidden" id="is_edit_bank" name="is_edit" value="false">
            <input type="hidden" id="original_bank_code" name="original_code" value="">
            
            <!-- Single row with all fields: ID, Code, Bank Name -->
            <div class="row g-2 mb-3">                
                <!-- Bank Code -->
                <div class="col-md-3">
                    <div class="d-flex align-items-center">
                        <label for="bank_code" class="form-label profile-fixed-label">Code</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="bank_code" name="bank_code"
                            value="" placeholder="" maxlength="6">
                    </div>
                </div>
                
                <!-- Bank Name -->
                <div class="col-md-7">
                    <div class="d-flex align-items-center">
                        <label for="bank_name" class="form-label profile-fixed-label">Bank Name</label>
                        <input type="text" class="form-control form-control-sm profile-fixed-input" id="bank_name" name="name"
                            value="" placeholder="Full bank name" maxlength="50">
                    </div>
                </div>
            </div>
            
            <!-- Buttons -->
            <div class="row g-2">
                <div class="col-md-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" id="clearBtnBank" class="btn btn-sm profile-clear-btn">Clear</button>
                        <button type="submit" id="saveBtnBank" class="btn btn-sm profile-save-btn">Save</button>
                        <button type="button" id="deleteBtnBank" class="btn btn-sm profile-delete-btn" style="display: none;">Delete</button>
                        <button type="submit" formaction="{% url 'profiles' %}?tab=bank" class="btn btn-sm profile-search-btn">Search</button>
                        <button type="button" id="reportBtnBank" class="btn btn-sm profile-report-btn">Report</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Banks Table -->
    <div class="mx-auto" style="width: 80%">
        <h6 class="mb-3 text-start">Bank List</h6>
    </div>

    <div class="card mb-4 p-3 mx-auto" style="width: 80%">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
            <table class="table mb-0" style="min-width: 600px;">
                <thead class="table-light" style="position: sticky; top: 0; background: white; z-index: 1;">
                    <tr>
                        <th width="80" class="text-center">ID</th>
                        <th width="120" class="text-center">Acronym</th>
                        <th class="text-center">Bank Name</th>
                    </tr>
                </thead>
                <tbody id="bankTableBody">
                    {% for bank in banks %}
                    <tr class="bank-row" data-id="{{ bank.bank_id }}" 
                        data-acronym="{{ bank.bank_acronym }}"
                        data-name="{{ bank.name }}">
                        <td class="text-center"><strong>{{ bank.bank_id }}</strong></td>
                        <td class="text-center">{{ bank.bank_acronym }}</td>
                        <td>{{ bank.name }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center py-4">
                            No banks found. Create your first bank above.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Summary -->
    <div class="mx-auto text-end" style="width: 80%">
        <strong>Total Banks: {{ banks|length }}</strong>
    </div>
    {% endif %}
</div>

<!-- JAVASCRIPT (EXACTLY AS YOUR WORKING CODE) -->
<script>
    // Check which tab is active on page load
    function checkActiveTabAndInitialize() {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        
        // Initialize the appropriate tab based on URL parameter
        if (activeTab === 'product') {
            initializeProductTab();
        } else if (activeTab === 'customer') {
            initializeCustomerTab();
        } else if (activeTab === 'agent') {
            initializeAgentTab();
        } else if (activeTab === 'bank') {
            initializeBankTab();
        } else if (!activeTab) {
            // If no tab parameter, check if we're on product or customer tab by looking at form elements
            if (document.getElementById('productForm')) {
                initializeProductTab();
            } else if (document.getElementById('customerForm')) {
                initializeCustomerTab();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the appropriate tab
        checkActiveTabAndInitialize();
    });
    
    function initializeProductTab() {
        const productForm = document.getElementById('productForm');
        if (!productForm) return; // Exit if product form doesn't exist
        
        const productIdInput = document.getElementById('product_id');
        const isEditProductInput = document.getElementById('is_edit_product');
        const originalProductCodeInput = document.getElementById('original_product_code');
        const originalDescriptionInput = document.getElementById('original_description');
        const saveBtnProduct = document.getElementById('saveBtnProduct');
        const clearBtnProduct = document.getElementById('clearBtnProduct');
        const deleteBtnProduct = document.getElementById('deleteBtnProduct');
        const reportBtnProduct = document.getElementById('reportBtnProduct');
        const productRows = document.querySelectorAll('.product-row');
        const productCodeInput = document.getElementById('product_code');
        const descriptionInput = document.getElementById('description');
        const priceInput = document.getElementById('price');
        const quantityInput = document.getElementById('quantity');
        const statusSelect = document.getElementById('status'); // Changed from unitSelect
        
        // Store all existing product codes and descriptions from data attributes
        const existingProductCodes = new Set();
        const existingDescriptions = new Set();
        
        // Populate existing codes and descriptions from table rows
        productRows.forEach(row => {
            existingProductCodes.add(row.dataset.code);
            existingDescriptions.add(row.dataset.description.toLowerCase());
        });
        
        // Double-click functionality for products
        productRows.forEach(row => {
            row.addEventListener('dblclick', function() {
                console.log('Product row double-clicked:', this.dataset);
                
                // Populate form fields
                productIdInput.value = this.dataset.id;
                productCodeInput.value = this.dataset.code;
                descriptionInput.value = this.dataset.description;
                priceInput.value = this.dataset.price;
                quantityInput.value = this.dataset.quantity;
                statusSelect.value = this.dataset.status; // Changed from unitSelect
                
                // Store original values
                originalProductCodeInput.value = this.dataset.code;
                originalDescriptionInput.value = this.dataset.description;
                
                // Set hidden inputs
                isEditProductInput.value = 'true';
                
                // Change button text and show delete button
                saveBtnProduct.textContent = 'Update';
                deleteBtnProduct.style.display = 'inline-block';
                
                // Change form action for update
                productForm.action = "{% url 'product_update' 0 %}".replace('0', this.dataset.id);
                
                console.log('Product form updated for editing:', {
                    id: this.dataset.id,
                    code: this.dataset.code,
                    description: this.dataset.description,
                    price: this.dataset.price,
                    quantity: this.dataset.quantity,
                    status: this.dataset.status
                });
            });
        });
        
        // Check if product code is being changed during update
        productCodeInput.addEventListener('input', function() {
            if (isEditProductInput.value === 'true') {
                const currentCode = this.value;
                const originalCode = originalProductCodeInput.value;
                
                // If user changed the code, check if it exists
                if (currentCode !== originalCode) {
                    if (existingProductCodes.has(currentCode)) {
                        // Code already exists, show warning
                        alert('Product code already exists. Please use a different code.');
                        this.value = originalCode;
                    }
                }
            }
        });
        
        // Check if description is being changed during update
        descriptionInput.addEventListener('input', function() {
            if (isEditProductInput.value === 'true') {
                const currentDescription = this.value.toLowerCase();
                const originalDescription = originalDescriptionInput.value.toLowerCase();
                
                // If user changed the description, check if it exists (and it's not their own original description)
                if (currentDescription !== originalDescription && existingDescriptions.has(currentDescription) && currentDescription !== '') {
                    alert('Product description already exists. Please use a different description.');
                    this.value = originalDescriptionInput.value;
                }
            }
        });
        
        // Clear button functionality for products
        clearBtnProduct.addEventListener('click', function() {
            productForm.reset();
            productIdInput.value = '{{ next_product_id }}';
            isEditProductInput.value = 'false';
            originalProductCodeInput.value = '';
            originalDescriptionInput.value = '';
            saveBtnProduct.textContent = 'Save';
            deleteBtnProduct.style.display = 'none';
            statusSelect.value = 'Active'; // Changed from unitSelect
            
            // Reset form action to create
            productForm.action = "{% url 'product_create' %}";
            
            console.log('Product form cleared');
        });
        
        // Delete button functionality for products
        deleteBtnProduct.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this product?')) {
                // Create and submit delete form
                const deleteForm = document.createElement('form');
                deleteForm.method = 'POST';
                deleteForm.action = "{% url 'product_delete' 0 %}".replace('0', productIdInput.value);
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                
                const tabInput = document.createElement('input');
                tabInput.type = 'hidden';
                tabInput.name = 'tab';
                tabInput.value = 'product';
                
                deleteForm.appendChild(csrfInput);
                deleteForm.appendChild(tabInput);
                document.body.appendChild(deleteForm);
                deleteForm.submit();
            }
        });
        
        // Report button functionality (placeholder) for products
        reportBtnProduct.addEventListener('click', function() {
            alert('Product report functionality to be implemented');
        });
        
        // Get price from URL parameters and set it
        const urlParams = new URLSearchParams(window.location.search);
        const priceParam = urlParams.get('price');
        if (priceParam) {
            priceInput.value = priceParam;
        }
        
        // Get status from URL parameters and set it
        const statusParam = urlParams.get('status');
        if (statusParam) {
            statusSelect.value = statusParam;
        }
        
        // Debug: Log initial state
        console.log('Product form initialized:', {
            saveBtnText: saveBtnProduct.textContent,
            deleteBtnDisplay: deleteBtnProduct.style.display,
            existingProductCodes: Array.from(existingProductCodes),
            existingDescriptions: Array.from(existingDescriptions)
        });
    }
    
    function initializeCustomerTab() {
        const customerForm = document.getElementById('customerForm');
        if (!customerForm) return; // Exit if customer form doesn't exist
        
        const customerIdInput = document.getElementById('customer_id');
        const isEditCustomerInput = document.getElementById('is_edit_customer');
        const originalCustomerCodeInput = document.getElementById('original_customer_code');
        const originalCompanyNameInput = document.getElementById('original_company_name');
        const saveBtnCustomer = document.getElementById('saveBtnCustomer');
        const clearBtnCustomer = document.getElementById('clearBtnCustomer');
        const deleteBtnCustomer = document.getElementById('deleteBtnCustomer');
        const reportBtnCustomer = document.getElementById('reportBtnCustomer');
        const customerRows = document.querySelectorAll('.customer-row');
        const customerCodeInput = document.getElementById('customer_code');
        const companyNameInput = document.getElementById('company_name');
        const contactPersonInput = document.getElementById('contact_person');
        const phoneInput = document.getElementById('phone');
        const areaSelect = document.getElementById('area');
        const addressInput = document.getElementById('customer_address');
        
        // Store all existing customer codes and names from data attributes
        const existingCustomerCodes = new Set();
        const existingCompanyNames = new Set();
        
        // Populate existing codes and names from table rows
        customerRows.forEach(row => {
            existingCustomerCodes.add(row.dataset.code);
            existingCompanyNames.add(row.dataset.name.toLowerCase());
        });
        
        // Function to get next available customer code
        function getNextAvailableCustomerCode() {
            let maxCode = 0;
            existingCustomerCodes.forEach(code => {
                // Extract numeric part from code (e.g., C001 -> 1)
                const match = code.match(/\d+/);
                if (match) {
                    const num = parseInt(match[0]);
                    if (num > maxCode) maxCode = num;
                }
            });
            
            // Format next code (e.g., C002)
            const nextNum = maxCode + 1;
            return 'C' + nextNum.toString().padStart(3, '0');
        }
        
        // Double-click functionality for customers
        customerRows.forEach(row => {
            row.addEventListener('dblclick', function() {
                console.log('Customer row double-clicked:', this.dataset);
                
                // Populate form fields
                customerCodeInput.value = this.dataset.code;
                companyNameInput.value = this.dataset.name;
                contactPersonInput.value = this.dataset.contact;
                phoneInput.value = this.dataset.phone;
                areaSelect.value = this.dataset.area;
                addressInput.value = this.dataset.address;
                
                // Store original values
                originalCustomerCodeInput.value = this.dataset.code;
                originalCompanyNameInput.value = this.dataset.name;
                
                // Set hidden inputs
                customerIdInput.value = this.dataset.id;
                isEditCustomerInput.value = 'true';
                
                // Change button text and show delete button
                saveBtnCustomer.textContent = 'Update';
                deleteBtnCustomer.style.display = 'inline-block';
                
                // Change form action for update
                customerForm.action = "{% url 'customer_update' 0 %}".replace('0', this.dataset.id);
                
                console.log('Customer form updated for editing:', {
                    id: this.dataset.id,
                    code: this.dataset.code,
                    name: this.dataset.name,
                    area: this.dataset.area,
                    address: this.dataset.address
                });
            });
        });
        
        // Check if customer code is being changed during update
        customerCodeInput.addEventListener('input', function() {
            if (isEditCustomerInput.value === 'true') {
                const currentCode = this.value;
                const originalCode = originalCustomerCodeInput.value;
                
                // If user changed the code, check if it exists
                if (currentCode !== originalCode) {
                    if (existingCustomerCodes.has(currentCode)) {
                        // Code already exists, show warning and auto-correct
                        alert('Customer code already exists. Auto-correcting to next available code.');
                        this.value = getNextAvailableCustomerCode();
                        // Since code changed, this should be a new record
                        saveBtnCustomer.textContent = 'Save';
                        deleteBtnCustomer.style.display = 'none';
                        isEditCustomerInput.value = 'false';
                        customerIdInput.value = '';
                        customerForm.action = "{% url 'customer_create' %}";
                    } else if (currentCode === '') {
                        // If user clears the code, auto-fill with next available
                        this.value = getNextAvailableCustomerCode();
                    }
                }
            }
        });
        
        // Check if company name is being changed during update
        companyNameInput.addEventListener('input', function() {
            if (isEditCustomerInput.value === 'true') {
                const currentName = this.value.toLowerCase();
                const originalName = originalCompanyNameInput.value.toLowerCase();
                
                // If user changed the name, check if it exists (and it's not their own original name)
                if (currentName !== originalName && existingCompanyNames.has(currentName) && currentName !== '') {
                    alert('Customer name already exists. Please use a different name.');
                    this.focus();
                }
            }
        });
        
        // Clear button functionality for customers
        clearBtnCustomer.addEventListener('click', function() {
            customerForm.reset();
            customerIdInput.value = '';
            isEditCustomerInput.value = 'false';
            originalCustomerCodeInput.value = '';
            originalCompanyNameInput.value = '';
            saveBtnCustomer.textContent = 'Save';
            deleteBtnCustomer.style.display = 'none';
            
            // Reset form action to create
            customerForm.action = "{% url 'customer_create' %}";
            
            // Reset the code field to next available code
            customerCodeInput.value = getNextAvailableCustomerCode();
            
            // Reset dropdown
            areaSelect.selectedIndex = 0;
            
            console.log('Customer form cleared');
        });
        
        // Delete button functionality for customers
        deleteBtnCustomer.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this customer?')) {
                // Create and submit delete form
                const deleteForm = document.createElement('form');
                deleteForm.method = 'POST';
                deleteForm.action = "{% url 'customer_delete' 0 %}".replace('0', customerIdInput.value);
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                
                const tabInput = document.createElement('input');
                tabInput.type = 'hidden';
                tabInput.name = 'tab';
                tabInput.value = 'customer';
                
                deleteForm.appendChild(csrfInput);
                deleteForm.appendChild(tabInput);
                document.body.appendChild(deleteForm);
                deleteForm.submit();
            }
        });
        
        // Report button functionality (placeholder) for customers
        reportBtnCustomer.addEventListener('click', function() {
            alert('Customer report functionality to be implemented');
        });
        
        // Initialize with next available code if field is empty
        if (!customerCodeInput.value) {
            customerCodeInput.value = getNextAvailableCustomerCode();
        }
        
        // Get area from URL parameters and set it
        const urlParams = new URLSearchParams(window.location.search);
        const areaParam = urlParams.get('area');
        if (areaParam) {
            areaSelect.value = areaParam;
        }
        
        // Debug: Log initial state
        console.log('Customer form initialized:', {
            saveBtnText: saveBtnCustomer.textContent,
            deleteBtnDisplay: deleteBtnCustomer.style.display,
            existingCustomerCodes: Array.from(existingCustomerCodes),
            existingCompanyNames: Array.from(existingCompanyNames)
        });
    }
    
    // Agent Tab JavaScript
    function initializeAgentTab() {
        const agentForm = document.getElementById('agentForm');
        if (!agentForm) return;
        
        const agentIdDisplay = document.getElementById('agent_id_display');
        const agentIdInput = document.querySelector('input[name="agent_id"]');
        const isEditAgentInput = document.getElementById('is_edit_agent');
        const originalAgentNameInput = document.getElementById('original_agent_name');
        const saveBtnAgent = document.getElementById('saveBtnAgent');
        const clearBtnAgent = document.getElementById('clearBtnAgent');
        const deleteBtnAgent = document.getElementById('deleteBtnAgent');
        const agentRows = document.querySelectorAll('.agent-row');
        const agentNameInput = document.getElementById('agent_name');
        const agentPhoneInput = document.getElementById('agent_phone');
        
        // Double-click functionality for agents
        agentRows.forEach(row => {
            row.addEventListener('dblclick', function() {
                // Populate form fields
                agentIdDisplay.value = this.dataset.id;
                agentIdInput.value = this.dataset.id;
                agentNameInput.value = this.dataset.name;
                agentPhoneInput.value = this.dataset.phone;
                
                // Store original values
                originalAgentNameInput.value = this.dataset.name;
                
                // Set hidden inputs
                isEditAgentInput.value = 'true';
                
                // Change button text and show delete button
                saveBtnAgent.textContent = 'Update';
                deleteBtnAgent.style.display = 'inline-block';
                
                // Change form action for update
                agentForm.action = "{% url 'agent_update' 0 %}".replace('0', this.dataset.id);
            });
        });
        
        // Clear button functionality
        clearBtnAgent.addEventListener('click', function() {
            agentForm.reset();
            agentIdDisplay.value = '{{ next_agent_id }}';
            agentIdInput.value = '{{ next_agent_id }}';
            isEditAgentInput.value = 'false';
            originalAgentNameInput.value = '';
            saveBtnAgent.textContent = 'Save';
            deleteBtnAgent.style.display = 'none';
            agentForm.action = "{% url 'agent_create' %}";
        });
        
        // Delete button functionality
        deleteBtnAgent.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this agent?')) {
                const deleteForm = document.createElement('form');
                deleteForm.method = 'POST';
                deleteForm.action = "{% url 'agent_delete' 0 %}".replace('0', agentIdInput.value);
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                
                const tabInput = document.createElement('input');
                tabInput.type = 'hidden';
                tabInput.name = 'tab';
                tabInput.value = 'agent';
                
                deleteForm.appendChild(csrfInput);
                deleteForm.appendChild(tabInput);
                document.body.appendChild(deleteForm);
                deleteForm.submit();
            }
        });
    }
    
    // Bank Tab JavaScript
    function initializeBankTab() {
        const bankForm = document.getElementById('bankForm');
        if (!bankForm) return;
        
        const bankIdDisplay = document.getElementById('bank_id_display');
        const bankIdInput = document.querySelector('input[name="bank_id"]');
        const isEditBankInput = document.getElementById('is_edit_bank');
        const originalBankAcronymInput = document.getElementById('original_bank_acronym');
        const saveBtnBank = document.getElementById('saveBtnBank');
        const clearBtnBank = document.getElementById('clearBtnBank');
        const deleteBtnBank = document.getElementById('deleteBtnBank');
        const bankRows = document.querySelectorAll('.bank-row');
        const bankAcronymInput = document.getElementById('bank_acronym');
        const bankNameInput = document.getElementById('bank_name');
        
        // Double-click functionality for banks
        bankRows.forEach(row => {
            row.addEventListener('dblclick', function() {
                // Populate form fields
                bankIdDisplay.value = this.dataset.id;
                bankIdInput.value = this.dataset.id;
                bankAcronymInput.value = this.dataset.acronym;
                bankNameInput.value = this.dataset.name;
                
                // Store original values
                originalBankAcronymInput.value = this.dataset.acronym;
                
                // Set hidden inputs
                isEditBankInput.value = 'true';
                
                // Change button text and show delete button
                saveBtnBank.textContent = 'Update';
                deleteBtnBank.style.display = 'inline-block';
                
                // Change form action for update
                bankForm.action = "{% url 'bank_update' 0 %}".replace('0', this.dataset.id);
            });
        });
        
        // Clear button functionality
        clearBtnBank.addEventListener('click', function() {
            bankForm.reset();
            bankIdDisplay.value = '{{ next_bank_id }}';
            bankIdInput.value = '{{ next_bank_id }}';
            isEditBankInput.value = 'false';
            originalBankAcronymInput.value = '';
            saveBtnBank.textContent = 'Save';
            deleteBtnBank.style.display = 'none';
            bankForm.action = "{% url 'bank_create' %}";
        });
        
        // Delete button functionality
        deleteBtnBank.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this bank?')) {
                const deleteForm = document.createElement('form');
                deleteForm.method = 'POST';
                deleteForm.action = "{% url 'bank_delete' 0 %}".replace('0', bankIdInput.value);
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                
                const tabInput = document.createElement('input');
                tabInput.type = 'hidden';
                tabInput.name = 'tab';
                tabInput.value = 'bank';
                
                deleteForm.appendChild(csrfInput);
                deleteForm.appendChild(tabInput);
                document.body.appendChild(deleteForm);
                deleteForm.submit();
            }
        });
    }
</script>
{% endblock %}